# Copilot Session Instructions & Context

This file serves as a persistent context buffer for the `quasarpy` project. It should be updated whenever significant architectural changes are made or a new phase of development begins.

## Project Overview
**Project:** `quasarpy`
**Description:** A Python wrapper for the Quasar Engine (ODYSSEE CAE), enabling programmatic control over Quasar simulations, data formatting, and execution.

## Key Components

### 1. Core Logic (`quasarpy/quasar.py`)
- **`Quasar` Class**: Manages the lifecycle of a Quasar run.
    - Handles temporary directory creation/cleanup.
    - Copies necessary `.qsr` scripts to the working directory.
    - Formats input (`X_FILE.csv`) and output (`Y_FILE.csv`) files with specific delimiters (semicolons) and scientific notation.
    - Generates command-line arguments for `QuasarEngine_2.exe`.
    - Executes the engine via `subprocess`.
- **Configuration**:
    - `DatasetConfig`: Defines a dataset and its solver settings.
    - `KrigingConfig`: Specific settings for the Kriging solver (basis function, stationarity, etc.).
- **Executable Discovery**:
    - Automatically looks for `QuasarEngine_2.exe` using `ODYSSEE_CAE_INSTALLDIR` or `ODYSSEE_SOLVER_INSTALLDIR` environment variables.

### 2. Scripts (`quasarpy/qsr_scripts/`)
- **`Simulation.qsr`**: Main entry point script for the engine.
- **`CustomSolver.qsr`**: Auxiliary script for custom solver logic.
- These files are bundled with the package and copied to the runtime work directory.

### 3. File Terminology & Mapping
Based on ODYSSEE CAE architecture:
- **Input X-file** (`X_FILE.csv`): Design of Experiments (DOE) variables.
- **Input Y-file** (`Y_FILE.csv`): Simulation results (time response functions) corresponding to the X-file.
- **Input XN-file** (`XN_FILE.csv`): New variable set for prediction.
- **Output YN-file** (`YN.csv`): Predicted response functions (ROM output).
- **Validation File** (`VALIDATION_FILE.csv`): Currently created as empty, reserved for validation data.

### 4. Testing (`tests/test_quasar.py`)
- **Unit Tests**: Verify file formatting, command generation, and initialization logic.
- **Integration Tests**: `test_quasar_integration` runs the actual executable if available (skipped otherwise).
- **Mocking**: Uses `unittest.mock` to simulate subprocess calls for tests that don't require the engine.

### 5. Demo (`demo.ipynb`)
- Interactive notebook demonstrating the end-to-end workflow:
    1. Setup Data (Pandas DataFrames).
    2. Configure Datasets.
    3. Initialize Quasar.
    4. Train.
    5. Predict.

## Current Status (as of Dec 2, 2025)
- **Recovered Context**: Session history was restored from internal state files.
- **Recent Changes**:
    - Implemented robust executable path detection using environment variables.
    - Updated `test_quasar.py` to reflect these changes and ensure tests pass whether the engine is installed or not.
    - **Fixed Tests**: Resolved issues in `test_write_y_file` (header check), `test_command_generation` (path normalization), `test_predict_mocked` (mocking `Popen`), and `test_quasar_integration` (data collinearity causing LU decomposition failure).
    - **Documentation**: Added comprehensive NumPy-style docstrings to `quasarpy/quasar.py` and `test/test_quasar.py`.
    - **Visualization**: Enhanced `test_quasar_integration` to generate plots (`quasar_integration_test.png`) showing both predictions and training data.
    - All tests in `test/test_quasar.py` are passing.
- **Immediate Goals**:
    - Continue refining tests.
    - Ensure `Simulation.qsr` and `CustomSolver.qsr` logic aligns with the Python wrapper's expectations.

## Instructions for Future Sessions
- **Always check this file** at the start of a session to understand the project state.
- **Update this file** when completing a major task or changing the architecture.
- **Test frequently**: Run `pytest` to ensure no regressions in file formatting or command generation.
